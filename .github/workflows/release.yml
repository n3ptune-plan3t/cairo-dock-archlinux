name: Build cairo-dock (Artix)
on:
  push:
    branches: [ main ]
  workflow_dispatch:
jobs:
  build:
    name: Build (Artix)
    runs-on: ubuntu-latest
    container:
      image: artixlinux/artixlinux:base-devel
      options: --security-opt seccomp=unconfined
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Update system & install build deps
        run: |
          pacman -Syu --noconfirm
          # pkg depends
          pacman -S --noconfirm --needed \
            gtk3 gdk-pixbuf2 glib2 cairo pango librsvg \
            dbus dbus-glib libxml2 libxrender glu curl \
            libx11 libxtst libxcomposite libxrandr libxinerama \
            wayland json-c gtk-layer-shell
          # make deps
          pacman -S --noconfirm --needed \
            cmake extra-cmake-modules wayland-protocols
      - name: Add build user (required for makepkg)
        run: |
          useradd -m builduser
          echo "builduser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown -R builduser:builduser .
      - name: Build package
        run: |
          sudo -u builduser bash -lc "
            makepkg -sf --noconfirm
          "
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cairo-dock-artix
          path: "*.pkg.tar.*"
